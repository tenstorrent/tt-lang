name: Build tt-mlir automatically (FetchContent)

on:
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    schedule:
        - cron: "0 12 * * *" # 4am PST

permissions:
    checks: write
    contents: read

jobs:
    build-tt-lang-tt-mlir:
        runs-on: ubuntu-latest
        timeout-minutes: 360

        container: ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest

        defaults:
            run:
                shell: bash

        env:
            TT_LANG_HOME: ${{ github.workspace }}
            TTMLIR_TOOLCHAIN_DIR: /opt/ttmlir-toolchain
            TT_MLIR_DIR: ${{ github.workspace }}/build/tt-mlir-install
            CMAKE_BUILD_PARALLEL_LEVEL: 2

        steps:
            - name: Maximize space
              uses: tenstorrent/tt-github-actions/.github/actions/maximize_space@main

            - name: Checkout tt-lang
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              shell: bash
              run: |
                  df -h
                  bash .github/scripts/determine-ttmlir-commit.sh "${{ inputs.tt-mlir-commit }}" "third-party/tt-mlir.commit"

            - name: Get LLVM version
              id: llvm-version
              uses: ./.github/actions/get-llvm-version

            - name: Cache tt-mlir installation
              id: cache-ttmlir
              uses: actions/cache@v4
              with:
                  path: |
                      build/tt-mlir-install
                      build/tools/ttrt
                  key: ${{ runner.os }}-ttlang-fetchcontent-ttmlir-${{ steps.ttmlir-commit.outputs.commit }}-llvm-${{ steps.llvm-version.outputs.version }}-v2

            - name: Setup ccache for tt-lang
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                  key: ${{ runner.os }}-ttlang-fetchcontent-llvm${{ steps.llvm-version.outputs.version }}
                  max-size: 200M

            - name: Build tt-lang
              run: |
                  echo "Building tt-lang with tt-mlir commit: ${{ steps.ttmlir-commit.outputs.commit }}"
                  df -h
                  cmake -G Ninja -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/build/tt-mlir-install \
                      -DTTMLIR_CMAKE_BUILD_TYPE=Release \
                      -DTTMLIR_ENABLE_RUNTIME=ON \
                      -DTTMLIR_ENABLE_RUNTIME_TESTS=ON \
                      -DCMAKE_CXX_COMPILER=clang++-17 \
                      -DCMAKE_C_COMPILER=clang-17 \
                      -DTTMLIR_GIT_TAG=${{ steps.ttmlir-commit.outputs.commit }}
                  cmake --build build
                  cmake --install build
                  df -h

            - name: Ensure ttrt wheel is in expected location
              run: |
                  # ttrt is built during main build (via FetchContent tt-mlir with ALL target)
                  # Wheel is at build/_deps/tt-mlir-build/tools/ttrt/build/
                  # Create symlink/copy to expected location for caching and upload
                  mkdir -p build/tools/ttrt
                  if [ -d build/_deps/tt-mlir-build/tools/ttrt/build ]; then
                      ln -sfn ../../_deps/tt-mlir-build/tools/ttrt/build build/tools/ttrt/build
                      echo "✅ Created symlink to ttrt wheel directory"
                      ls -lh build/_deps/tt-mlir-build/tools/ttrt/build/ttrt*.whl
                  elif [ -d build/tools/ttrt/build ] && [ -f build/tools/ttrt/build/ttrt*.whl ]; then
                      echo "✅ Found ttrt wheel in expected location (from cache)"
                      ls -lh build/tools/ttrt/build/ttrt*.whl
                  else
                      echo "❌ ttrt wheel not found at expected locations"
                      exit 1
                  fi

            - name: Test the build
              run: |
                  source build/env/activate
                  python test/python/smoketest.py

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ttlang-fetchcontent-build-ubuntu
                  path: |
                      build/python_packages
                      build/test
                      build/env
                      sim/
                  retention-days: 1

            - name: Upload ttrt wheels
              uses: actions/upload-artifact@v4
              with:
                  name: ttlang-fetchcontent-ttrt-whl-ubuntu
                  path: build/tools/ttrt/build/ttrt*.whl
                  if-no-files-found: error
                  retention-days: 1

            - name: Verify tt-mlir installation exists
              run: |
                  if [ ! -d "build/tt-mlir-install" ]; then
                      echo "❌ tt-mlir installation does not exist: build/tt-mlir-install"
                      exit 1
                  fi
                  echo "✅ tt-mlir installation exists: build/tt-mlir-install"
                  ls -la build/tt-mlir-install

            - name: Archive tt-mlir installation
              run: |
                  cd build/tt-mlir-install && tar -I 'zstd --long=31 --adapt=min=9 -T0' -cf ../../tt-mlir-install.tar.zst .

            - name: Upload tt-mlir installation for hardware tests
              uses: actions/upload-artifact@v4
              with:
                  name: ttlang-fetchcontent-ttmlir-install-ubuntu
                  path: tt-mlir-install.tar.zst
                  if-no-files-found: error
                  retention-days: 1

            - name: Clean up tt-mlir installation archive
              run: rm -f tt-mlir-install.tar.zst

    test-hardware:
        needs: build-tt-lang-tt-mlir
        strategy:
            matrix:
                hardware: [n150, n300, tg, p150]
        uses: ./.github/workflows/call-test-hardware.yml
        secrets: inherit
        with:
            runs-on: ${{ matrix.hardware }}
            build-os: ubuntu
            timeout: 60
            artifact-prefix: ttlang-fetchcontent

    check-all-green:
        if: always()
        needs:
            - build-tt-lang-tt-mlir
            - test-hardware
        runs-on: ubuntu-latest
        steps:
            - name: Decide whether all needed jobs succeeded or failed
              uses: re-actors/alls-green@release/v1
              with:
                  jobs: ${{ toJSON(needs) }}
