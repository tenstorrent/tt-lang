name: Build tt-lang with tt-mlir (FetchContent) and run HW tests

on:
    push:
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    # schedule:
    #     - cron: "0 12 * * *"

permissions:
    checks: write
    contents: read

jobs:
    build-tt-lang-tt-mlir:
        # runs-on: test1-large-runner-lang
        runs-on: ubuntu-latest
        timeout-minutes: 360

        container: ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest

        defaults:
            run:
                shell: bash

        env:
            TT_LANG_HOME: ${{ github.workspace }}
            TTMLIR_TOOLCHAIN_DIR: /opt/ttmlir-toolchain
            TT_MLIR_DIR: ${{ github.workspace }}/tt-mlir-install
            TTLANG_CMAKE_DEBUG: 1
            CMAKE_BUILD_PARALLEL_LEVEL: 2

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              shell: bash
              run: |
                  df -h
                  bash .github/scripts/determine-ttmlir-commit.sh "${{ inputs.tt-mlir-commit }}" "third-party/tt-mlir.commit"

            - name: Get LLVM version
              id: llvm-version
              uses: ./.github/actions/get-llvm-version

            - name: Cache tt-mlir installation only
              id: cache-ttmlir
              uses: actions/cache@v4
              with:
                  path: tt-mlir-install
                  key: ${{ runner.os }}-ttlang-fetchcontent-ttmlir-${{ steps.ttmlir-commit.outputs.commit }}-llvm-${{ steps.llvm-version.outputs.version }}

            - name: Setup ccache for tt-lang
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                  key: ${{ runner.os }}-ttlang-fetchcontent-llvm${{ steps.llvm-version.outputs.version }}
                  max-size: 100M

            - name: Debug cache status and fix paths
              run: |
                  set -x
                  echo "Cache hit output: '${{ steps.cache-ttmlir.outputs.cache-hit }}'"
                  # NOTE: github.workspace may differ from $(pwd) inside containers!
                  # Always use $(pwd) for the actual working directory
                  CURRENT_WORKSPACE="$(pwd)"
                  echo "Current workspace (pwd): $CURRENT_WORKSPACE"
                  echo "github.workspace: ${{ github.workspace }}"
                  echo "Checking if tt-mlir-install exists:"
                  ls -la tt-mlir-install/lib/cmake/ttmlir/ 2>/dev/null || echo "tt-mlir-install not found or incomplete"

                  # The cached TTMLIRConfig.cmake contains hardcoded absolute paths from when
                  # the cache was created. Different GitHub Actions runners use different workspace
                  # paths (/__w/... vs /home/runner/work/...). Fix by replacing paths in cmake files.
                  if [ -f tt-mlir-install/lib/cmake/ttmlir/TTMLIRConfig.cmake ]; then
                      echo "=== TTMLIRConfig.cmake first 20 lines ==="
                      head -20 tt-mlir-install/lib/cmake/ttmlir/TTMLIRConfig.cmake

                      # Extract the old workspace path from the cmake file
                      # Look for paths ending in /tt-mlir-install
                      OLD_PATH=$(grep -oP '[^"]+(?=/tt-mlir-install)' tt-mlir-install/lib/cmake/ttmlir/TTMLIRConfig.cmake | head -1)
                      echo "Detected old workspace path: '$OLD_PATH'"
                      echo "Current workspace path: '$CURRENT_WORKSPACE'"

                      if [ -n "$OLD_PATH" ] && [ "$OLD_PATH" != "$CURRENT_WORKSPACE" ]; then
                          echo "Paths differ, fixing cmake files..."

                          # Find all cmake files that might have hardcoded paths
                          CMAKE_FILES=$(find tt-mlir-install -name "*.cmake" -type f)
                          echo "Found cmake files:"
                          echo "$CMAKE_FILES"

                          # Replace old workspace path with current workspace (use pwd, not github.workspace!)
                          for cmake_file in $CMAKE_FILES; do
                              echo "Fixing paths in: $cmake_file"
                              sed -i "s|${OLD_PATH}|${CURRENT_WORKSPACE}|g" "$cmake_file"
                          done

                          # Add TTMLIR_DIR to TTMLIRConfig.cmake if it doesn't exist
                          # CMake's find_package requires <Package>_DIR to be set
                          CONFIG_FILE="tt-mlir-install/lib/cmake/ttmlir/TTMLIRConfig.cmake"
                          if ! grep -q "^set(TTMLIR_DIR" "$CONFIG_FILE"; then
                              echo "Adding TTMLIR_DIR to TTMLIRConfig.cmake"
                              # Add after TTMLIR_CMAKE_DIR line
                              sed -i '/^set(TTMLIR_CMAKE_DIR/a set(TTMLIR_DIR "${TTMLIR_CMAKE_DIR}" CACHE PATH "Path to TTMLIR cmake config" FORCE)' "$CONFIG_FILE"
                          fi

                          echo "=== TTMLIRConfig.cmake after fix ==="
                          head -25 tt-mlir-install/lib/cmake/ttmlir/TTMLIRConfig.cmake

                          # Verify library files exist
                          echo "=== Checking library files ==="
                          ls -la tt-mlir-install/lib/*.so 2>/dev/null | head -10 || echo "No .so files found"
                          ls -la tt-mlir-install/lib/*.a 2>/dev/null | head -10 || echo "No .a files found"
                      else
                          echo "Paths match or could not detect old path, no fix needed"
                      fi
                  fi

                  # Clean any stale build directory to avoid CMake cache issues
                  rm -rf build

            - name: Configure tt-lang (builds tt-mlir with tt-metal)
              if: ${{ steps.cache-ttmlir.outputs.cache-hit != 'true' }}
              run: |
                  echo "Configuring tt-lang with tt-mlir commit: ${{ steps.ttmlir-commit.outputs.commit }}"
                  cmake -G Ninja -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DCMAKE_CXX_COMPILER=clang++-17 \
                      -DCMAKE_C_COMPILER=clang-17 \
                      -DTTMLIR_CMAKE_BUILD_TYPE=Release \
                      -DTTMLIR_INSTALL_PREFIX=${{ env.TT_MLIR_DIR }} \
                      -DTTMLIR_GIT_TAG=${{ steps.ttmlir-commit.outputs.commit }}

            - name: Configure tt-lang with pre-installed tt-mlir
              if: ${{ steps.cache-ttmlir.outputs.cache-hit == 'true' }}
              run: |
                  echo "Configuring tt-lang with pre-installed (cached) tt-mlir"
                  # NOTE: github.workspace may differ from $(pwd) inside containers
                  # Use $(pwd) to get the actual working directory
                  ACTUAL_TTMLIR_DIR="$(pwd)/tt-mlir-install"
                  echo "Using TTMLIR_DIR: $ACTUAL_TTMLIR_DIR"
                  ls -la "$ACTUAL_TTMLIR_DIR/lib/cmake/ttmlir/TTMLIRConfig.cmake"
                  cmake -G Ninja -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DCMAKE_CXX_COMPILER=clang++-17 \
                      -DCMAKE_C_COMPILER=clang-17 \
                      -DTTMLIR_DIR="$ACTUAL_TTMLIR_DIR/lib/cmake/ttmlir"

            - name: Build tt-lang
              run: |
                  source build/env/activate
                  cmake --build build

            - name: Test the tt-lang build
              run: |
                  source build/env/activate
                  python test/python/smoketest.py

            - name: Run ttlang Lit MLIR tests
              run: |
                source build/env/activate
                cmake --build build --target check-ttlang-mlir

            - name: Run ttlang Python bindings tests
              run: |
                source build/env/activate
                cmake --build build --target check-ttlang-python-bindings

            - name: Clean up tt-mlir build directory
              if: ${{ steps.cache-ttmlir.outputs.cache-hit != 'true' }}
              run: |
                  rm -rf build/_deps/tt-mlir-*

            - name: Archive build artifacts
              run: |
                  set -x
                  ARTIFACT_NAME=$(.github/scripts/get-artifact-archive-name.sh "${{ github.sha }}")
                  echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

                  # Archive both tt-mlir-install and build directories from workspace root
                  tar -I 'zstd --long=31 --adapt=min=9 -T0' -cf "${ARTIFACT_NAME}" \
                    tt-mlir-install build/python_packages build/test build/env

            - name: Upload build artifacts for hardware tests
              uses: actions/upload-artifact@v4
              with:
                  name: ttlang-fetchcontent-ttmlir-install-ubuntu
                  path: ${{ env.ARTIFACT_NAME }}
                  if-no-files-found: error
                  retention-days: 1


    test-hardware:
        needs: build-tt-lang-tt-mlir
        uses: ./.github/workflows/call-test-hardware.yml
        secrets: inherit
        with:
            runs-on: n150
            build-os: ubuntu
            timeout: 60
            artifact-prefix: ttlang-fetchcontent

    check-all-green:
        if: always()
        needs:
            - build-tt-lang-tt-mlir
            - test-hardware
        runs-on: ubuntu-latest
        steps:
            - name: Decide whether all needed jobs succeeded or failed
              uses: re-actors/alls-green@release/v1
              with:
                  jobs: ${{ toJSON(needs) }}
                  allowed-failures: test-hardware
