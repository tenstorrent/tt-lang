name: Build tt-mlir automatically (FetchContent)

on:
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
    schedule:
        - cron: "0 12 * * *" # 4am PST

jobs:
    build-tt-lang-tt-mlir:
        runs-on: ubuntu-latest
        timeout-minutes: 360

        defaults:
            run:
                shell: bash

        env:
            TT_LANG_HOME: ${{ github.workspace }}
            TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain

        steps:
            - name: Maximize build space
              uses: easimon/maximize-build-space@master
              with:
                  root-reserve-mb: 30720
                  remove-dotnet: 'true'
                  remove-android: 'true'
                  remove-haskell: 'true'
                  remove-codeql: 'true'
                  remove-docker-images: 'true'

            - name: Checkout tt-lang
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              shell: bash
              run: |
                  if [ -n "${{ inputs.tt-mlir-commit }}" ]; then
                      echo "commit=${{ inputs.tt-mlir-commit }}" >> $GITHUB_OUTPUT
                      echo "Using tt-mlir commit from input: ${{ inputs.tt-mlir-commit }}"
                  else
                      COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
                      echo "commit=$COMMIT" >> $GITHUB_OUTPUT
                      echo "Using tt-mlir commit from file: $COMMIT"
                  fi

            - name: Checkout tt-mlir (for toolchain build)
              uses: actions/checkout@v4
              with:
                  repository: tenstorrent/tt-mlir
                  ref: ${{ steps.ttmlir-commit.outputs.commit }}
                  path: tt-mlir
                  submodules: recursive
                  fetch-depth: 1

            - name: Setup Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang cmake lld ninja-build
                  python -m pip install --upgrade pip

            - name: Create toolchain directory
              run: |
                  mkdir -p ${{ github.workspace }}/ttmlir-toolchain

            - name: Cache tt-mlir toolchain
              id: cache-toolchain
              uses: actions/cache@v4
              with:
                  path: ${{ github.workspace }}/ttmlir-toolchain
                  key: ubuntu-ttmlir-toolchain-${{ hashFiles('tt-mlir/env/CMakeLists.txt') }}-${{ github.ref_name }}
                  restore-keys: |
                      ubuntu-ttmlir-toolchain-${{ hashFiles('tt-mlir/env/CMakeLists.txt') }}

            - name: Check if toolchain was restored
              id: check-toolchain
              run: |
                  if [ -f ${{ github.workspace }}/ttmlir-toolchain/venv/bin/python3 ] && [ -f ${{ github.workspace }}/ttmlir-toolchain/bin/llvm-config ]; then
                      echo "restored=true" >> $GITHUB_OUTPUT
                      echo "Toolchain was restored from cache"
                  else
                      echo "restored=false" >> $GITHUB_OUTPUT
                      echo "Toolchain needs to be built"
                  fi

            - name: Build tt-mlir toolchain
              if: steps.check-toolchain.outputs.restored != 'true'
              run: |
                  sudo df -h
                  cd tt-mlir
                  cmake -B env/build env
                  cmake --build env/build

            - name: Get LLVM version
              id: llvm-version
              uses: ./.github/actions/get-llvm-version

            - name: Cache tt-mlir installation
              id: cache-ttmlir
              uses: actions/cache@v4
              with:
                  path: |
                      build/tt-mlir-install
                      build/_deps
                  key: ${{ runner.os }}-ttlang-fetchcontent-ttmlir-${{ steps.ttmlir-commit.outputs.commit }}-llvm-${{ steps.llvm-version.outputs.version }}

            - name: Setup ccache for tt-lang
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                  key: ${{ runner.os }}-ttlang-fetchcontent-llvm${{ steps.llvm-version.outputs.version }}

            - name: Build tt-lang
              run: |
                  cmake -G Ninja -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DTTMLIR_CMAKE_BUILD_TYPE=Release \
                      -DTTMLIR_ENABLE_RUNTIME=OFF \
                      -DTTMLIR_ENABLE_RUNTIME_TESTS=OFF \
                      -DTTMLIR_GIT_TAG=${{ steps.ttmlir-commit.outputs.commit }}
                  cmake --build build
                  source build/env/activate
                  python test/python/smoketest.py

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-scenario-3-ubuntu
                  path: |
                      build/python_packages
                      sim/
                  retention-days: 1
