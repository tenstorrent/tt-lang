name: Build tt-lang with tt-mlir and run HW tests

# This workflow builds and tests tt-lang using a cached toolchain.
# The toolchain (LLVM + tt-mlir) is built by call-build-ttmlir-toolchain.yml.
#
# If the cache doesn't exist, this workflow fails with a clear error message.
# Run the toolchain workflow first if you see cache miss errors.

on:
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            linux_runner:
                description: "Linux runner to use"
                type: choice
                options:
                    - ubuntu-latest
                    - mlir-large-runner-lang
                default: "mlir-large-runner-lang"
            build_docs:
                description: "Build and deploy documentation."
                type: boolean
                default: false
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            linux_runner:
                description: "Linux runner to use (ubuntu-latest or mlir-large-runner-lang)"
                type: string
                required: false
                default: "mlir-large-runner-lang"
            build_docs:
                description: "Build and deploy documentation."
                type: boolean
                required: false
                default: false
    schedule:
        - cron: "0 12 * * *"

permissions:
    checks: write
    contents: read

jobs:
    build-and-test-tt-lang-nohw:
        name: build-and-test-tt-lang-nohw (${{ inputs.linux_runner || 'mlir-large-runner-lang' }})
        runs-on: ${{ inputs.linux_runner || 'mlir-large-runner-lang' }}
        timeout-minutes: 60  # Reduced - only building tt-lang, not LLVM/tt-mlir

        defaults:
            run:
                shell: bash

        env:
            TT_LANG_HOME: ${{ github.workspace }}
            TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain
            CMAKE_BUILD_PARALLEL_LEVEL: 2

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install build dependencies
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: build-essential ninja-build lld clang-17 clang++-17 libzstd-dev
                  version: 1.0  # Bump to force package refresh

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              run: |
                  df -h
                  bash .github/scripts/determine-ttmlir-commit.sh "${{ inputs.tt-mlir-commit }}" "third-party/tt-mlir.commit"

            - name: Restore toolchain from cache
              id: cache-toolchain
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: Linux-ttlang-toolchain-v1-${{ steps.ttmlir-commit.outputs.commit }}

            - name: Check cache was restored
              run: |
                  .github/scripts/check-toolchain-cache.sh \
                      "${{ steps.cache-toolchain.outputs.cache-hit }}" \
                      "${{ steps.ttmlir-commit.outputs.commit }}" \
                      "${{ github.repository }}"

            - name: Setup ccache
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                  key: ${{ runner.os }}-ttlang-${{ github.ref_name }}
                  restore-keys: |
                      ${{ runner.os }}-ttlang-main
                  max-size: 200M

            - name: Build tt-lang
              uses: ./.github/actions/build-ttlang
              with:
                  toolchain_dir: ${{ env.TTMLIR_TOOLCHAIN_DIR }}
                  enable_docs: ${{ inputs.build_docs && 'true' || 'false' }}

            - name: Test the tt-lang build
              run: |
                  source build/env/activate
                  python test/python/smoketest.py

            - name: Run ttlang Lit MLIR tests
              run: |
                source build/env/activate
                cmake --build build --target check-ttlang-mlir

            - name: Run ttlang Python bindings tests
              run: |
                source build/env/activate
                cmake --build build --target check-ttlang-python-bindings

            - name: Python lit tests
              run: |
                source build/env/activate
                cmake --build build --target check-ttlang-python-lit

            - name: Build documentation
              if: inputs.build_docs
              run: |
                source build/env/activate
                cmake --build build --target ttlang-docs

            - name: Upload documentation artifact
              if: inputs.build_docs
              uses: actions/upload-pages-artifact@v3
              with:
                path: ./build/docs/sphinx/_build/html

            - name: Archive build artifacts
              run: |
                  set -x
                  ARTIFACT_NAME=$(.github/scripts/get-artifact-archive-name.sh "${{ github.sha }}")
                  echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

                  # Archive toolchain and tt-lang build directory
                  tar -I 'zstd --long=31 --adapt=min=9 -T0' -cf "${ARTIFACT_NAME}" \
                    --exclude='build/_deps' \
                    ttmlir-toolchain build

            - name: Upload build artifacts for hardware tests
              uses: actions/upload-artifact@v4
              with:
                  name: ttlang-fetchcontent-ttmlir-install-ubuntu
                  path: ${{ env.ARTIFACT_NAME }}
                  if-no-files-found: error
                  retention-days: 1


    test-ttlang-on-tt-hw:
        needs: build-and-test-tt-lang-nohw
        uses: ./.github/workflows/call-test-hardware.yml
        secrets: inherit
        with:
            runs-on: n150
            build-os: ubuntu
            timeout: 60
            artifact-prefix: ttlang-fetchcontent
