name: Build

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            timeout: 180
            use-container: true
          - os: macos-26
            timeout: 360
            use-container: false

    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}

    container: ${{ matrix.use-container && 'ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest' || '' }}

    defaults:
      run:
        shell: bash

    env:
      TT_LANG_HOME: ${{ github.workspace }}
      TT_MLIR_HOME: ${{ github.workspace }}/tt-mlir
      TT_MLIR_DIR: ${{ github.workspace }}/tt-mlir-install

    steps:
      - name: Checkout tt-lang
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read tt-mlir version
        id: ttmlir-version
        run: |
          TTMLIR_COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$TTMLIR_COMMIT" >> $GITHUB_OUTPUT

      - name: Checkout tt-mlir
        uses: actions/checkout@v4
        with:
          repository: tenstorrent/tt-mlir
          ref: ${{ steps.ttmlir-version.outputs.commit }}
          path: tt-mlir
          submodules: recursive
          fetch-depth: 0 # Fetch full history and tags

      # macOS-specific: Setup toolchain
      - name: Setup macOS toolchain
        if: runner.os == 'macOS'
        uses: ./.github/actions/setup-macos-toolchain
        with:
          tt-mlir-path: tt-mlir

      # Common steps (MacOS and Ubuntu) from here down
      - name: Get LLVM version
        id: llvm-version
        uses: ./.github/actions/get-llvm-version

      - name: Cache tt-mlir installation
        id: cache-ttmlir
        uses: actions/cache@v4
        with:
          path: ${{ env.TT_MLIR_DIR }}
          key: ${{ runner.os }}-ttlang-ttmlir-${{ hashFiles('third-party/tt-mlir.commit') }}-llvm-${{ steps.llvm-version.outputs.version }}

      - name: Configure and build tt-mlir
        if: steps.cache-ttmlir.outputs.cache-hit != 'true'
        run: |
          cd tt-mlir
          source env/activate
          ${{ runner.os == 'macOS' && 'export CMAKE_BUILD_PARALLEL_LEVEL=2' || 'echo ""' }}
          cmake -G Ninja \
            -B build -DCMAKE_INSTALL_PREFIX=${{ env.TT_MLIR_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DTTMLIR_ENABLE_SHARED_LIB=ON \
            -DTTMLIR_ENABLE_RUNTIME=OFF \
            -DTTMLIR_ENABLE_RUNTIME_TESTS=OFF \
            -DTTMLIR_ENABLE_STABLEHLO=OFF \
            -DTTMLIR_ENABLE_OPMODEL=ON \
            -DTT_RUNTIME_ENABLE_PERF_TRACE=OFF \
            -DTTMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DTTMLIR_ENABLE_DEBUG_STRINGS=ON \
            -DTTMLIR_ENABLE_EXPLORER=OFF \
            -DBUILD_TESTING=OFF \
            -S .
          cmake --build build --target all --target TTMLIRPythonModules
          cmake --install build
          cmake --install build --component TTMLIRPythonWheel

      # - name: Setup ccache for tt-lang
      #   uses: hendrikmuhs/ccache-action@v1.2
      #   with:
      #     key: ${{ github.job }}-${{ runner.os }}-llvm-${{ steps.llvm-version.outputs.version }}
      #     max-size: 200M

      # - name: Configure tt-lang
      #   run: |
      #     source /opt/ttmlir-toolchain/venv/bin/activate
      #     cmake -G Ninja \
      #       -B build \
      #       -DCMAKE_BUILD_TYPE=Release \
      #       -DTTMLIR_BUILD_DIR=$GITHUB_WORKSPACE/tt-mlir/build \
      #       -DTTLANG_ENABLE_BINDINGS_PYTHON=ON \
      #       -S .

      # - name: Build tt-lang
      #   run: |
      #     source build/env/activate
      #     cmake --build build --config Release

      # - name: Test the build
      #   run: |
      #     source build/env/activate
      #     python test/python/smoketest.py

      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: build-${{ runner.os == 'Linux' && 'ubuntu' || 'macos' }}
      #     path: |
      #       build/python_packages
      #       sim/
      #     retention-days: 1
