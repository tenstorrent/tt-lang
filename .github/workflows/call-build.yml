name: Build

on:
  workflow_call:
    inputs:
      run_macos:
        description: "Run the macOS build."
        type: boolean
        required: false
        default: false
      build_docs:
        description: "Build and deploy documentation."
        type: boolean
        required: false
        default: false
      linux_runner:
        description: "Linux runner to use (ubuntu-latest or test1-large-runner-lang)"
        type: string
        required: false
        default: "test1-large-runner-lang"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(inputs.run_macos && format('[{{"os":"{0}","timeout":240,"use_container":true}},{{"os":"macos-26","timeout":360,"use_container":false}}]', inputs.linux_runner) || format('[{{"os":"{0}","timeout":240,"use_container":true}}]', inputs.linux_runner)) }}

    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}

    container: ${{ matrix.use_container && 'ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest' || '' }}

    defaults:
      run:
        shell: bash

    env:
      TT_LANG_HOME: ${{ github.workspace }}
      TT_MLIR_HOME: ${{ github.workspace }}/tt-mlir
      TT_MLIR_DIR: ${{ github.workspace }}/tt-mlir-install
      TTMLIR_TOOLCHAIN_DIR: /opt/ttmlir-toolchain

    steps:
      - name: Maximize space
        if: runner.os == 'Linux'
        uses: tenstorrent/tt-github-actions/.github/actions/maximize_space@main

      - name: Checkout tt-lang
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read tt-mlir version
        id: ttmlir-version
        run: |
          TTMLIR_COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$TTMLIR_COMMIT" >> $GITHUB_OUTPUT

      - name: Checkout tt-mlir
        uses: actions/checkout@v4
        with:
          repository: tenstorrent/tt-mlir
          ref: ${{ steps.ttmlir-version.outputs.commit }}
          path: tt-mlir
          submodules: recursive
          fetch-depth: 0 # Fetch full history and tags

      - name: Compute toolchain hash
        if: runner.os == 'macOS'
        id: toolchain-hash
        run: |
          HASH=$(shasum tt-mlir/env/CMakeLists.txt | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      # macOS-specific: Setup toolchain
      - name: Setup macOS toolchain
        if: runner.os == 'macOS'
        uses: ./.github/actions/setup-macos-toolchain
        with:
          tt-mlir-path: tt-mlir
          toolchain-hash: ${{ steps.toolchain-hash.outputs.hash }}

      # Common steps (MacOS and Ubuntu) from here down
      - name: Compute tt-mlir commit hash
        id: ttmlir-commit-hash
        run: |
          HASH=$(shasum third-party/tt-mlir.commit | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Get LLVM version
        id: llvm-version
        uses: ./.github/actions/get-llvm-version

      - name: Cache tt-mlir installation
        id: cache-ttmlir
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.TT_MLIR_DIR }}
          key: ${{ runner.os }}-ttlang-ttmlir-${{ steps.ttmlir-commit-hash.outputs.hash }}-llvm-${{ steps.llvm-version.outputs.version }}

      - name: Configure and build tt-mlir
        if: steps.cache-ttmlir.outputs.cache-hit != 'true'
        run: |
          cd tt-mlir
          source env/activate
          ${{ runner.os == 'macOS' && 'export CMAKE_BUILD_PARALLEL_LEVEL=2' || 'echo ""' }}
          cmake -G Ninja \
            -B build -DCMAKE_INSTALL_PREFIX=${{ env.TT_MLIR_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DTTMLIR_ENABLE_SHARED_LIB=ON \
            -DTTMLIR_ENABLE_RUNTIME=${{ runner.os == 'Linux' && 'ON' || 'OFF' }} \
            -DTTMLIR_ENABLE_RUNTIME_TESTS=OFF \
            -DTTMLIR_ENABLE_TTRT=OFF \
            -DTTMLIR_ENABLE_STABLEHLO=OFF \
            -DTTMLIR_ENABLE_OPMODEL=OFF \
            -DTTMLIR_ENABLE_EXPLORER=OFF \
            -DTTMLIR_ENABLE_ALCHEMIST=OFF \
            -DTT_RUNTIME_ENABLE_PERF_TRACE=OFF \
            -DTTMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DTT_RUNTIME_ENABLE_TTNN=ON \
            -DTTMLIR_ENABLE_TTNN_JIT=ON \
            -DUSE_TTNN_JIT_WHEEL=OFF \
            -DBUILD_TESTING=OFF \
            -S .
          cmake --build build --target all --target TTMLIRPythonModules
          cmake --install build

      - name: Setup ccache for tt-lang
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ttlang-llvm${{ steps.llvm-version.outputs.version }}
          max-size: 200M

      - name: Configure tt-lang
        run: |
          source ${{ env.TTMLIR_TOOLCHAIN_DIR }}/venv/bin/activate
          cmake -G Ninja \
            -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DTTMLIR_TOOLCHAIN_DIR=${{ env.TTMLIR_TOOLCHAIN_DIR }} \
            -DTTMLIR_DIR=${{ env.TT_MLIR_DIR }}/lib/cmake/ttmlir \
            -DTTLANG_ENABLE_BINDINGS_PYTHON=ON \
            -DTTLANG_ENABLE_DOCS=${{ inputs.build_docs && 'ON' || 'OFF' }} \
            -S .

      - name: Build tt-lang
        run: |
          source build/env/activate
          cmake --build build --config Release

      - name: Test the build
        run: |
          source build/env/activate
          python test/python/smoketest.py

      - name: Run ttlang Lit MLIR tests
        run: |
          source build/env/activate
          cmake --build build --target check-ttlang-mlir

      - name: Run ttlang Python bindings tests
        run: |
          source build/env/activate
          cmake --build build --target check-ttlang-python-bindings

      - name: Python lit tests
        run: |
          source build/env/activate
          cmake --build build --target check-ttlang-python-lit

      - name: Build documentation
        if: inputs.build_docs && runner.os == 'Linux'
        run: |
          source build/env/activate
          cmake --build build --target ttlang-docs

      - name: Upload documentation artifact
        if: inputs.build_docs && runner.os == 'Linux'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build/docs/sphinx/_build/html

      - name: Normalize tt-mlir installation
        run: |
          # Replace symlinks with actual files to make tt-mlir-install self-contained
          # This can be removed once tt-mlir install is fixed upstream
          .github/scripts/normalize-ttmlir-install.sh ${{ env.TT_MLIR_DIR }}

      - name: Archive build artifacts
        id: archive
        run: |
          set -x
          ARTIFACT_NAME=$(.github/scripts/get-artifact-archive-name.sh "${{ github.sha }}")
          echo "name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

          # Archive self-contained tt-mlir-install and tt-lang build directory
          tar -I 'zstd --long=31 --adapt=min=9 -T0' -cf "${ARTIFACT_NAME}" \
            --exclude='build/_deps' \
            ${{ env.TT_MLIR_DIR }} build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ttlang-ttmlir-install-${{ runner.os == 'Linux' && 'ubuntu' || 'macos' }}
          path: ${{ steps.archive.outputs.name }}
          if-no-files-found: error
          retention-days: 1
