name: Hardware Tests

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: 'Hardware type to run on'
        required: false
        type: string
        default: 'n150'
      build-os:
        description: 'Which build artifacts to use (ubuntu or macos)'
        required: false
        type: string
        default: 'ubuntu'
      artifact-prefix:
        description: 'Prefix for artifact names (ttlang or ttlang-fetchcontent)'
        required: false
        type: string
        default: 'ttlang'
      timeout:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 30
  workflow_call:
    inputs:
      runs-on:
        description: 'Hardware type to run on'
        required: false
        type: string
        default: 'n150'
      build-os:
        description: 'Which build artifacts to use (ubuntu or macos)'
        required: false
        type: string
        default: 'ubuntu'
      artifact-prefix:
        description: 'Prefix for artifact names (ttlang or ttlang-fetchcontent)'
        required: false
        type: string
        default: 'ttlang'
      timeout:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 30

permissions:
  checks: write
  contents: read

jobs:
  test-n150:
    name: "Hardware Tests (${{ inputs.runs-on }})"
    runs-on: ${{ format('tt-ubuntu-2204-{0}-stable', inputs.runs-on) }}
    timeout-minutes: ${{ inputs.timeout }}

    container:
      image: ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest
      options: --device /dev/tenstorrent
      volumes:
        - /dev/hugepages:/dev/hugepages
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /etc/udev/rules.d:/etc/udev/rules.d
        - /lib/modules:/lib/modules

    defaults:
      run:
        shell: bash

    env:
      RUNS_ON: ${{ inputs.runs-on }}
      PYTHONDONTWRITEBYTECODE: 1

    steps:
      - name: Checkout tt-lang
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git safe directory
        run: git config --global --add safe.directory "$(pwd)"

      - name: Download build artifacts archive
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('{0}-ttmlir-install-{1}', inputs.artifact-prefix, inputs.build-os) }}
          path: .

      - name: Extract build artifacts
        run: |
          set -x
          ARTIFACT_FILE=$(.github/scripts/get-artifact-archive-name.sh "${{ github.sha }}")
          tar -I 'zstd --long=31' -xf "${ARTIFACT_FILE}"
          rm -f "${ARTIFACT_FILE}"
          echo "Checking tt-mlir-install structure..."
          ls -la tt-mlir-install/ tt-mlir-install/python_packages/ || echo "Did not unpack tt-mlir-install"
          ls -la /opt/ttmlir-toolchain/venv/bin || echo "No valid ttmlir-toolchain found"
          find tt-mlir-install/python_packages -name "*ttcore*" 2>/dev/null || echo "No ttcore in tt-mlir-install"

      - name: Install test dependencies
        run: |
          source build/env/activate
          pip install -r dev-requirements.txt

      - name: Smoketest
        run: |
          source build/env/activate
          python3 test/python/smoketest.py

      - name: Single test (just python)
        run: |
          source build/env/activate
          python test/python/simple_add.py

      - name: Python lit tests
        run: |
          source build/env/activate
          cmake --build build --target check-ttlang-python-lit

      - name: ME2E tests (MLIR input end-to-end tests)
        run: |
          source build/env/activate
          python3 -m pytest test/me2e -v --tb=short --junitxml=build/test/me2e-report.xml

      - name: Pytests (Python DSL end-to-end tests)
        run: |
          source build/env/activate
          # Run pytest directly instead of through ninja
          python3 -m pytest test/python -v --tb=long --junitxml=build/test/pytest-report.xml

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hardware-test-reports-${{ inputs.runs-on }}
          path: |
            build/test/python-lit-report.xml
            build/test/me2e-report.xml
            build/test/pytest-report.xml
          retention-days: 7
