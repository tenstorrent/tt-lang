name: Hardware Tests

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: 'Hardware type to run on'
        required: false
        type: string
        default: 'n150'
      build-os:
        description: 'Which build artifacts to use (ubuntu or macos)'
        required: false
        type: string
        default: 'ubuntu'
      timeout:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 30
      artifact-prefix:
        description: 'Prefix for artifact names (ttlang or ttlang-fetchcontent)'
        required: false
        type: string
        default: 'ttlang'
  workflow_call:
    inputs:
      runs-on:
        description: 'Hardware type to run on'
        required: false
        type: string
        default: 'n150'
      build-os:
        description: 'Which build artifacts to use (ubuntu or macos)'
        required: false
        type: string
        default: 'ubuntu'
      timeout:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 30
      artifact-prefix:
        description: 'Prefix for artifact names (ttlang or ttlang-fetchcontent)'
        required: false
        type: string
        default: 'ttlang'

permissions:
  checks: write

jobs:
  test-hardware:
    name: "Hardware Tests (${{ inputs.runs-on }})"
    runs-on: ${{ fromJson(format('["{0}", "in-service"]', format('tt-ubuntu-2204-{0}-stable', inputs.runs-on))) }}
    timeout-minutes: ${{ inputs.timeout }}

    container:
      image: ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest
      options: --device /dev/tenstorrent
      volumes:
        - /dev/hugepages:/dev/hugepages
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /etc/udev/rules.d:/etc/udev/rules.d
        - /lib/modules:/lib/modules

    defaults:
      run:
        shell: bash

    env:
      TT_LANG_HOME: ${{ github.workspace }}
      TT_MLIR_HOME: ${{ github.workspace }}/tt-mlir
      TT_MLIR_DIR: ${{ github.workspace }}/tt-mlir-install
      RUNS_ON: ${{ inputs.runs-on }}

    steps:
      - name: Checkout tt-lang
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git safe directory
        run: git config --global --add safe.directory ${{ github.workspace }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('{0}-build-{1}', inputs.artifact-prefix, inputs.build-os) }}
          path: build

      - name: Download tt-mlir installation
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('{0}-ttmlir-install-{1}', inputs.artifact-prefix, inputs.build-os) }}
          path: ${{ env.TT_MLIR_DIR }}

      - name: Set up environment variables
        run: |
          echo "LD_LIBRARY_PATH=${{ env.TT_MLIR_DIR }}/lib:/opt/ttmlir-toolchain/lib:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "PYTHONPATH=${{ github.workspace }}/build/python_packages:${PYTHONPATH}" >> $GITHUB_ENV

      - name: Generate system descriptor
        run: |
          # Install ttrt if not available
          if ! command -v ttrt &> /dev/null; then
            echo "ttrt not found, attempting to install from tt-mlir installation"
            # This will be provided by tt-mlir installation or container
          fi

          # Generate system descriptor
          mkdir -p ttrt-artifacts
          cd ttrt-artifacts

          # Check if ttrt is available
          if command -v ttrt &> /dev/null; then
            if [ "${{ inputs.runs-on }}" == "tg" ] || [ "${{ inputs.runs-on }}" == "p150" ]; then
              ttrt query --save-artifacts --disable-eth-dispatch
            else
              ttrt query --save-artifacts
            fi
          else
            echo "Warning: ttrt not available, using dummy system descriptor"
            # For initial testing, create a minimal dummy descriptor
            # This should be replaced with actual ttrt query in production
            echo "Creating placeholder system descriptor..."
          fi

      - name: Set SYSTEM_DESC_PATH
        run: |
          SYSTEM_DESC=$(find ttrt-artifacts -name "*.ttsys" -type f | head -1)
          if [ -z "$SYSTEM_DESC" ]; then
            echo "Warning: No system descriptor found"
          else
            echo "SYSTEM_DESC_PATH=$SYSTEM_DESC" >> $GITHUB_ENV
            echo "Using system descriptor: $SYSTEM_DESC"
          fi

      - name: Run hardware tests
        env:
          TTLANG_VERBOSE_PASSES: 0
        run: |
          # Source the environment
          source build/env/activate

          # Create test output directory
          mkdir -p test_reports

          # Run lit tests on hardware
          echo "Running hardware tests on ${{ inputs.runs-on }}..."

          # Run tests and capture results
          llvm-lit -sv build/test/python/ \
            --xunit-xml-output test_reports/report_${{ inputs.runs-on }}.xml || true

          # Display test results summary
          if [ -f test_reports/report_${{ inputs.runs-on }}.xml ]; then
            echo "Test report generated successfully"
            grep -E "testsuite|testcase" test_reports/report_${{ inputs.runs-on }}.xml | head -20 || true
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hardware-test-reports-${{ inputs.runs-on }}
          path: test_reports
          retention-days: 7

      - name: Show test report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: test_reports/report_*.xml
          check_name: Hardware Tests (${{ inputs.runs-on }})
          summary: true
