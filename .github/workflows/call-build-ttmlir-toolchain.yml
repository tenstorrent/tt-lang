name: Build tt-mlir Toolchain (Cache)

# Dedicated workflow to build and cache the LLVM + tt-mlir toolchain.
# Other workflows restore from this cache using fail-on-cache-miss: true.
#
# Architecture:
# - check-cache (ubuntu-latest): Check if caches exist
# - build-llvm (ubuntu-latest): Build LLVM on standard runner (cheaper)
# - build-ttmlir (mlir-large-runner-lang): Build tt-mlir on large runner
#
# Best practice: https://github.com/actions/cache
# "It is a recommended practice to use a dedicated job or workflow to build
# and save dependencies, which can then be restored by other jobs or workflows."

on:
    # Called by on-pr.yml to ensure cache exists before build
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            force_rebuild:
                description: 'Force rebuild even if cache exists'
                required: false
                type: boolean
                default: false
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            force_rebuild:
                description: 'Force rebuild even if cache exists'
                required: false
                type: boolean
                default: false
        outputs:
            cache-key:
                description: "The cache key for the toolchain"
                value: ${{ jobs.check-cache.outputs.cache-key }}
            ttmlir-commit:
                description: "The tt-mlir commit SHA used"
                value: ${{ jobs.check-cache.outputs.ttmlir-commit }}
    # Keep cache warm nightly
    schedule:
        - cron: "0 6 * * *"  # Nightly at 6 AM UTC

permissions:
    contents: read

jobs:
    # TEMPORARY: Migrate existing toolchain cache to LLVM-only format
    # Set if: true to run once, then remove this entire job
    migrate-cache:
        name: Migrate toolchain cache to LLVM-only
        runs-on: ubuntu-latest
        if: true  # TODO: Set to false or remove after running once
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Determine tt-mlir commit
              id: commit
              run: |
                  COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
                  echo "commit=$COMMIT" >> $GITHUB_OUTPUT

            - name: Restore full toolchain cache (from main branch format)
              id: restore-cache
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: Linux-ttlang-ttmlir-toolchain-${{ steps.commit.outputs.commit }}-v2
                  restore-keys: |
                      Linux-ttlang-ttmlir-toolchain-

            - name: Check cache was restored
              run: |
                  if [ "${{ steps.restore-cache.outputs.cache-hit }}" != "true" ]; then
                      echo "No cache found matching key or restore-keys"
                      echo "Searched for: Linux-ttlang-ttmlir-toolchain-${{ steps.commit.outputs.commit }}-v2"
                      exit 1
                  fi
                  echo "Cache restored from: ${{ steps.restore-cache.outputs.cache-matched-key }}"

            - name: Cleanup toolchain (create stubs)
              run: .github/containers/cleanup-toolchain.sh ttmlir-toolchain

            - name: Save as LLVM-only cache
              uses: actions/cache/save@v4
              with:
                  path: ttmlir-toolchain
                  key: Linux-ttlang-llvm-only-v1-${{ steps.commit.outputs.commit }}

    # First job: Check if caches exist (runs on standard runner)
    check-cache:
        name: Check toolchain cache
        runs-on: ubuntu-latest
        timeout-minutes: 10

        outputs:
            cache-key: ${{ steps.cache-key.outputs.key }}
            llvm-cache-key: ${{ steps.cache-key.outputs.llvm-key }}
            ttmlir-commit: ${{ steps.ttmlir-commit.outputs.commit }}
            toolchain-cache-hit: ${{ steps.check-toolchain-cache.outputs.cache-hit }}
            llvm-cache-hit: ${{ steps.check-llvm-cache.outputs.cache-hit }}
            needs-llvm-build: ${{ steps.needs-build.outputs.needs-llvm }}
            needs-ttmlir-build: ${{ steps.needs-build.outputs.needs-ttmlir }}

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              run: |
                  bash .github/scripts/determine-ttmlir-commit.sh "${{ inputs.tt-mlir-commit }}" "third-party/tt-mlir.commit"

            - name: Generate cache keys
              id: cache-key
              run: |
                  COMMIT="${{ steps.ttmlir-commit.outputs.commit }}"
                  echo "key=Linux-ttlang-toolchain-v1-$COMMIT" >> $GITHUB_OUTPUT
                  echo "llvm-key=Linux-ttlang-llvm-only-v1-$COMMIT" >> $GITHUB_OUTPUT
                  echo "Toolchain cache key: Linux-ttlang-toolchain-v1-$COMMIT"
                  echo "LLVM cache key: Linux-ttlang-llvm-only-v1-$COMMIT"

            - name: Check if toolchain cache exists
              id: check-toolchain-cache
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ steps.cache-key.outputs.key }}
                  lookup-only: true

            - name: Check if LLVM cache exists
              id: check-llvm-cache
              if: steps.check-toolchain-cache.outputs.cache-hit != 'true'
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ steps.cache-key.outputs.llvm-key }}
                  lookup-only: true

            - name: Determine what builds are needed
              id: needs-build
              run: |
                  TOOLCHAIN_HIT="${{ steps.check-toolchain-cache.outputs.cache-hit }}"
                  LLVM_HIT="${{ steps.check-llvm-cache.outputs.cache-hit }}"
                  FORCE="${{ inputs.force_rebuild }}"

                  echo "toolchain-cache-hit=$TOOLCHAIN_HIT, llvm-cache-hit=$LLVM_HIT, force=$FORCE"

                  if [ "$TOOLCHAIN_HIT" == "true" ] && [ "$FORCE" != "true" ]; then
                      echo "Full toolchain cache exists. No builds needed."
                      echo "needs-llvm=false" >> $GITHUB_OUTPUT
                      echo "needs-ttmlir=false" >> $GITHUB_OUTPUT
                  elif [ "$LLVM_HIT" == "true" ] && [ "$FORCE" != "true" ]; then
                      echo "LLVM cache exists. Only tt-mlir build needed."
                      echo "needs-llvm=false" >> $GITHUB_OUTPUT
                      echo "needs-ttmlir=true" >> $GITHUB_OUTPUT
                  else
                      echo "No cache or force rebuild. Both builds needed."
                      echo "needs-llvm=true" >> $GITHUB_OUTPUT
                      echo "needs-ttmlir=true" >> $GITHUB_OUTPUT
                  fi

    # Second job: Build LLVM (standard runner - cheaper)
    build-llvm:
        name: Build LLVM toolchain
        needs: check-cache
        if: needs.check-cache.outputs.needs-llvm-build == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 240  # 4 hours for LLVM build

        env:
            TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain
            CMAKE_BUILD_PARALLEL_LEVEL: 2

        steps:
            - name: Maximize space
              uses: tenstorrent/tt-github-actions/.github/actions/maximize_space@main

            - name: Checkout tt-lang
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      build-essential ninja-build lld \
                      clang-17 clang++-17 \
                      libzstd-dev

            - name: Checkout tt-mlir
              uses: actions/checkout@v4
              with:
                  repository: tenstorrent/tt-mlir
                  ref: ${{ needs.check-cache.outputs.ttmlir-commit }}
                  path: tt-mlir-src
                  fetch-depth: 0

            - name: Create toolchain directory
              run: mkdir -p $TTMLIR_TOOLCHAIN_DIR

            - name: Build LLVM toolchain
              working-directory: tt-mlir-src
              run: |
                  echo "=== Building LLVM toolchain ==="
                  echo "This will take 2-3 hours..."
                  cmake -G Ninja -B env/build env
                  cmake --build env/build
                  rm -rf env/build  # Clean up build directory
                  echo "=== LLVM toolchain complete ==="
                  df -h

            - name: Save LLVM-only cache
              uses: actions/cache/save@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ needs.check-cache.outputs.llvm-cache-key }}

            - name: Verify LLVM cache contents
              run: |
                  echo "=== LLVM Toolchain contents ==="
                  ls -lh $TTMLIR_TOOLCHAIN_DIR/
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/llvm/LLVMConfig.cmake" && echo "LLVM: OK"
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/mlir/MLIRConfig.cmake" && echo "MLIR: OK"
                  test -x "$TTMLIR_TOOLCHAIN_DIR/venv/bin/python3" && echo "Python venv: OK"

    # Third job: Build tt-mlir via tt-lang FetchContent (large runner)
    build-ttmlir:
        name: Build tt-mlir (via tt-lang)
        needs: [check-cache, build-llvm]
        if: |
            always() &&
            needs.check-cache.outputs.needs-ttmlir-build == 'true' &&
            (needs.build-llvm.result == 'success' || needs.build-llvm.result == 'skipped')
        runs-on: mlir-large-runner-lang
        timeout-minutes: 120  # 2 hours for tt-mlir build

        env:
            TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain
            CMAKE_BUILD_PARALLEL_LEVEL: 2
            TTLANG_CMAKE_DEBUG: 1  # TODO: remove after debugging

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      build-essential ninja-build lld \
                      clang-17 clang++-17 \
                      libzstd-dev doxygen graphviz python3-sphinx \
                      libnuma-dev libhwloc-dev libopenmpi-dev openmpi-bin libcapstone-dev

            - name: Checkout tt-mlir
              uses: actions/checkout@v4
              with:
                  repository: tenstorrent/tt-mlir
                  ref: ${{ needs.check-cache.outputs.ttmlir-commit }}
                  path: tt-mlir-src
                  fetch-depth: 0
                  submodules: recursive

            - name: Restore LLVM-only cache
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ needs.check-cache.outputs.llvm-cache-key }}
                  fail-on-cache-miss: true

            - name: Build and install tt-lang (includes tt-mlir via FetchContent)
              run: |
                  .github/containers/build-and-install.sh \
                      --ttmlir-src-dir=${{ github.workspace }}/tt-mlir-src

            - name: Verify tt-mlir was installed
              run: |
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/ttmlir/TTMLIRConfig.cmake" || \
                      { echo "ERROR: TTMLIRConfig.cmake not found - tt-mlir install failed"; exit 1; }
                  echo "tt-mlir installed successfully"

            - name: Cleanup toolchain (create stubs for unused binaries)
              run: |
                  .github/containers/cleanup-toolchain.sh $TTMLIR_TOOLCHAIN_DIR
                  df -h

            - name: Save toolchain to cache
              uses: actions/cache/save@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ needs.check-cache.outputs.cache-key }}

            - name: Verify cache contents
              run: |
                  echo "=== Toolchain contents ==="
                  ls -lh $TTMLIR_TOOLCHAIN_DIR/

                  echo "=== Validating required files ==="
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/llvm/LLVMConfig.cmake" && echo "LLVM: OK"
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/mlir/MLIRConfig.cmake" && echo "MLIR: OK"
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/ttmlir/TTMLIRConfig.cmake" && echo "tt-mlir: OK"
                  test -d "$TTMLIR_TOOLCHAIN_DIR/python_packages/ttrt/runtime/ttnn" && echo "ttrt/TTNN: OK"
                  test -x "$TTMLIR_TOOLCHAIN_DIR/venv/bin/python3" && echo "Python venv: OK"

                  echo "=== Cache saved successfully ==="
