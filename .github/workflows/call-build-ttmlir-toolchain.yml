name: Build tt-mlir Toolchain (Cache)

# Dedicated workflow to build and cache the LLVM + tt-mlir toolchain.
# Other workflows restore from this cache using fail-on-cache-miss: true.
#
# Best practice: https://github.com/actions/cache
# "It is a recommended practice to use a dedicated job or workflow to build
# and save dependencies, which can then be restored by other jobs or workflows."

on:
    # Called by on-pr.yml to ensure cache exists before build
    workflow_dispatch:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            force_rebuild:
                description: 'Force rebuild even if cache exists'
                required: false
                type: boolean
                default: false
    workflow_call:
        inputs:
            tt-mlir-commit:
                description: 'tt-mlir commit SHA (overrides third-party/tt-mlir.commit)'
                required: false
                type: string
            force_rebuild:
                description: 'Force rebuild even if cache exists'
                required: false
                type: boolean
                default: false
        outputs:
            cache-key:
                description: "The cache key for the toolchain"
                value: ${{ jobs.check-cache.outputs.cache-key }}
            ttmlir-commit:
                description: "The tt-mlir commit SHA used"
                value: ${{ jobs.check-cache.outputs.ttmlir-commit }}
    # Keep cache warm nightly
    schedule:
        - cron: "0 6 * * *"  # Nightly at 6 AM UTC

permissions:
    contents: read

jobs:
    # First job: Check if cache exists (runs on standard runner)
    check-cache:
        name: Check toolchain cache
        runs-on: ubuntu-latest
        timeout-minutes: 10

        outputs:
            cache-key: ${{ steps.cache-key.outputs.key }}
            ttmlir-commit: ${{ steps.ttmlir-commit.outputs.commit }}
            cache-hit: ${{ steps.check-cache.outputs.cache-hit }}
            needs-build: ${{ steps.needs-build.outputs.result }}

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4

            - name: Determine tt-mlir commit
              id: ttmlir-commit
              run: |
                  bash .github/scripts/determine-ttmlir-commit.sh "${{ inputs.tt-mlir-commit }}" "third-party/tt-mlir.commit"

            - name: Generate cache key
              id: cache-key
              run: |
                  KEY="Linux-ttlang-toolchain-v1-${{ steps.ttmlir-commit.outputs.commit }}"
                  echo "key=$KEY" >> $GITHUB_OUTPUT
                  echo "Cache key: $KEY"

            - name: Check if cache exists
              id: check-cache
              uses: actions/cache/restore@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ steps.cache-key.outputs.key }}
                  lookup-only: true

            - name: Determine if build is needed
              id: needs-build
              run: |
                  if [ "${{ steps.check-cache.outputs.cache-hit }}" == "true" ] && [ "${{ inputs.force_rebuild }}" != "true" ]; then
                      echo "Cache exists and force_rebuild is not set. Skipping build."
                      echo "result=false" >> $GITHUB_OUTPUT
                  else
                      echo "Build needed: cache-hit=${{ steps.check-cache.outputs.cache-hit }}, force_rebuild=${{ inputs.force_rebuild }}"
                      echo "result=true" >> $GITHUB_OUTPUT
                  fi

    # Second job: Build toolchain (only runs if cache miss, uses large runner)
    build-toolchain:
        name: Build LLVM + tt-mlir toolchain
        needs: check-cache
        if: needs.check-cache.outputs.needs-build == 'true'
        runs-on: mlir-large-runner-lang
        timeout-minutes: 360  # 6 hours for LLVM + tt-mlir build

        env:
            TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain
            CMAKE_BUILD_PARALLEL_LEVEL: 2

        steps:
            - name: Checkout tt-lang
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      build-essential ninja-build lld \
                      clang-17 clang++-17 \
                      libzstd-dev

            - name: Checkout tt-mlir
              uses: actions/checkout@v4
              with:
                  repository: tenstorrent/tt-mlir
                  ref: ${{ needs.check-cache.outputs.ttmlir-commit }}
                  path: tt-mlir-src
                  fetch-depth: 0
                  fetch-tags: true

            - name: Create toolchain directory
              run: mkdir -p $TTMLIR_TOOLCHAIN_DIR

            - name: Build LLVM toolchain
              working-directory: tt-mlir-src
              run: |
                  echo "=== Building LLVM toolchain ==="
                  echo "This will take 2-3 hours..."
                  cmake -G Ninja -B env/build env
                  cmake --build env/build
                  rm -rf env/build  # Clean up build directory
                  echo "=== LLVM toolchain complete ==="
                  df -h

            - name: Configure tt-mlir
              working-directory: tt-mlir-src
              run: |
                  source $TTMLIR_TOOLCHAIN_DIR/venv/bin/activate
                  cmake -G Ninja -B build \
                      -DCMAKE_BUILD_TYPE=Release \
                      -DCMAKE_CXX_COMPILER=clang++-17 \
                      -DCMAKE_C_COMPILER=clang-17 \
                      -DCMAKE_INSTALL_PREFIX=$TTMLIR_TOOLCHAIN_DIR \
                      -DTTMLIR_ENABLE_RUNTIME=ON \
                      -DTTMLIR_ENABLE_STABLEHLO=OFF

            - name: Build tt-mlir
              working-directory: tt-mlir-src
              run: |
                  echo "=== Building tt-mlir ==="
                  source $TTMLIR_TOOLCHAIN_DIR/venv/bin/activate
                  cmake --build build
                  df -h

            - name: Install tt-mlir
              working-directory: tt-mlir-src
              run: |
                  source $TTMLIR_TOOLCHAIN_DIR/venv/bin/activate
                  cmake --install build

            - name: Copy ttrt runtime to toolchain
              run: |
                  mkdir -p $TTMLIR_TOOLCHAIN_DIR/python_packages/ttrt/runtime
                  cp -prL tt-mlir-src/build/python_packages/ttrt/runtime/* \
                      $TTMLIR_TOOLCHAIN_DIR/python_packages/ttrt/runtime/

            - name: Normalize and cleanup toolchain
              run: |
                  .github/scripts/normalize-ttmlir-install.sh $TTMLIR_TOOLCHAIN_DIR
                  .github/containers/cleanup-toolchain.sh $TTMLIR_TOOLCHAIN_DIR

            - name: Remove build artifacts
              run: |
                  rm -rf tt-mlir-src
                  df -h

            - name: Save toolchain to cache
              uses: actions/cache/save@v4
              with:
                  path: ttmlir-toolchain
                  key: ${{ needs.check-cache.outputs.cache-key }}

            - name: Verify cache contents
              run: |
                  echo "=== Toolchain contents ==="
                  ls -lh $TTMLIR_TOOLCHAIN_DIR/

                  echo "=== Validating required files ==="
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/llvm/LLVMConfig.cmake" && echo "LLVM: OK"
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/mlir/MLIRConfig.cmake" && echo "MLIR: OK"
                  test -f "$TTMLIR_TOOLCHAIN_DIR/lib/cmake/ttmlir/TTMLIRConfig.cmake" && echo "tt-mlir: OK"
                  test -d "$TTMLIR_TOOLCHAIN_DIR/python_packages/ttrt/runtime/ttnn" && echo "ttrt/TTNN: OK"
                  test -x "$TTMLIR_TOOLCHAIN_DIR/venv/bin/python3" && echo "Python venv: OK"

                  echo "=== Cache saved successfully ==="
