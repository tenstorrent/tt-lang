name: Build Docker Image

# Builds Docker images using the cached toolchain from call-build-ttmlir-toolchain.yml.
# Fails if cache doesn't exist - run the toolchain workflow first.

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      ttlang_sha_override:
        description: "tt-lang SHA/branch override (optional, defaults to current commit)"
        type: string
        required: false
      mlir_override:
        description: "tt-mlir SHA override (optional, defaults to third-party/tt-mlir.commit)"
        type: string
        required: false
  workflow_call:
    inputs:
      mlir_override:
        description: "tt-mlir SHA override (optional, defaults to third-party/tt-mlir.commit)"
        type: string
        required: false
    outputs:
      docker-image:
        description: "Built Docker image name with tag"
        value: ${{ jobs.check-if-images-already-exist.outputs.docker-image || jobs.build-image.outputs.docker-image }}

permissions:
  packages: write
  checks: write

jobs:
  check-if-images-already-exist:
    runs-on: ubuntu-latest
    outputs:
      docker-image: ${{ steps.check.outputs.docker-image }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ttlang_sha_override || github.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Read tt-mlir commit
        id: ttmlir-commit
        run: |
          COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Check if Docker image exists
        id: check
        run: .github/scripts/check-docker-images.sh "${{ steps.ttmlir-commit.outputs.commit }}"

  # Restore the toolchain from cache (FAILS if not present)
  # The toolchain is built by call-build-ttmlir-toolchain.yml
  restore-ttmlir-cache:
    needs: check-if-images-already-exist
    if: needs.check-if-images-already-exist.outputs.docker-image == ''
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      ttmlir-commit: ${{ steps.ttmlir-commit.outputs.commit }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ttlang_sha_override || github.sha }}

      - name: Read tt-mlir commit
        id: ttmlir-commit
        run: |
          COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Restore toolchain from cache
        id: cache-toolchain
        uses: actions/cache/restore@v4
        with:
          path: ttmlir-toolchain
          key: Linux-ttlang-toolchain-v1-${{ steps.ttmlir-commit.outputs.commit }}

      - name: Check cache was restored
        run: |
          .github/scripts/check-toolchain-cache.sh \
              "${{ steps.cache-toolchain.outputs.cache-hit }}" \
              "${{ steps.ttmlir-commit.outputs.commit }}" \
              "${{ github.repository }}"

      - name: Validate cache contents
        run: |
          TOOLCHAIN_DIR=ttmlir-toolchain

          test -f "$TOOLCHAIN_DIR/lib/cmake/llvm/LLVMConfig.cmake" || \
            { echo "ERROR: LLVMConfig.cmake missing"; exit 1; }
          test -f "$TOOLCHAIN_DIR/lib/cmake/mlir/MLIRConfig.cmake" || \
            { echo "ERROR: MLIRConfig.cmake missing"; exit 1; }
          test -f "$TOOLCHAIN_DIR/lib/cmake/ttmlir/TTMLIRConfig.cmake" || \
            { echo "ERROR: TTMLIRConfig.cmake missing"; exit 1; }
          test -d "$TOOLCHAIN_DIR/python_packages/ttrt/runtime/ttnn" || \
            { echo "ERROR: ttrt/TTNN runtime missing"; exit 1; }
          test -x "$TOOLCHAIN_DIR/venv/bin/python3" || \
            { echo "ERROR: Python venv missing"; exit 1; }

          echo "Cache validated successfully"

      - name: Upload toolchain as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ttmlir-toolchain-for-docker
          path: ttmlir-toolchain
          retention-days: 1

  build-image:
    needs: [check-if-images-already-exist, restore-ttmlir-cache]
    if: needs.check-if-images-already-exist.outputs.docker-image == ''
    runs-on: mlir-large-runner-lang
    timeout-minutes: 120

    outputs:
      docker-image: ${{ steps.build.outputs.docker-image }}

    steps:
      - name: Maximize space
        uses: tenstorrent/tt-github-actions/.github/actions/maximize_space@main

      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ttlang_sha_override || github.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Free up some more space
        run: |
          .github/scripts/cleanup-ci-space.sh

      - name: Download toolchain artifact
        uses: actions/download-artifact@v4
        with:
          name: ttmlir-toolchain-for-docker
          path: ttmlir-toolchain

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              build-essential ninja-build lld \
              clang-17 clang++-17 \
              libzstd-dev

      - name: Build tt-lang (outside Docker for space efficiency)
        uses: ./.github/actions/build-ttlang
        with:
          toolchain_dir: ${{ github.workspace }}/ttmlir-toolchain
          enable_perf_trace: 'true'

      - name: Show disk usage after build
        run: df -h

      - name: Create ttlang-install directory
        env:
          TTMLIR_TOOLCHAIN_DIR: ${{ github.workspace }}/ttmlir-toolchain
        run: |
          echo "=== Creating ttlang-install (toolchain + tt-lang) ==="

          # Copy toolchain as base
          cp -a ttmlir-toolchain ttlang-install

          # Install tt-lang into it
          cmake --install build --prefix ttlang-install

          # Copy Python packages
          cp -prL build/python_packages/ttl ttlang-install/python_packages/ 2>/dev/null || true
          cp -prL build/python_packages/pykernel ttlang-install/python_packages/ 2>/dev/null || true
          cp -prL build/python_packages/sim ttlang-install/python_packages/ 2>/dev/null || true

          # Copy examples and tests
          cp -r examples ttlang-install/ 2>/dev/null || true
          cp -r test ttlang-install/ 2>/dev/null || true

          # Copy env/activate script
          mkdir -p ttlang-install/env
          cp build/env/activate ttlang-install/env/

          # Clean up Python cache
          find ttlang-install -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

          # Remove build directory to save space
          rm -rf build

          echo "=== ttlang-install created ==="
          df -h

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Clean up Docker before build
        run: |
          echo "Cleaning up Docker system before build..."
          docker system prune -af --volumes || true
          docker builder prune -af || true
          echo "Docker cleanup complete"
          df -h

      - name: Build Docker images
        id: build
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_STEP_LOG_MAX_SIZE: -1
        run: |
          set -o pipefail
          set -x
          echo "Space usage: " && df -h
          .github/containers/build-docker-images.sh "${{ needs.restore-ttmlir-cache.outputs.ttmlir-commit }}" \
              --ttmlir-toolchain=ttmlir-toolchain \
              --ttlang-install=ttlang-install | tee docker.log

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "ERROR: Docker build failed"
            exit 1
          fi

          DOCKER_IMAGE=$(tail -n 1 docker.log)
          echo "docker-image=$DOCKER_IMAGE" >> $GITHUB_OUTPUT

          echo "Space usage after build: " && df -h
          echo "Docker images built successfully"

      - name: Clean up Docker after build
        if: always()
        run: |
          echo "Cleaning up Docker build cache after build..."
          docker builder prune -af || true
          echo "Docker cleanup complete"
          df -h

      - name: Show disk usage on failure
        if: failure()
        run: |
          echo "=== Disk Usage ==="
          df -h
          echo ""
          echo "=== Disk Usage by Directory ==="
          du -h --max-depth=2 ${{ github.workspace }} 2>/dev/null | sort -hr | head -20 || true
          echo ""
          echo "=== Docker Disk Usage ==="
          docker system df || true

  set-latest-tag:
    needs: [check-if-images-already-exist, build-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !failure()
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Set latest tag
        run: |
          DOCKER_IMAGE="${{ needs.check-if-images-already-exist.outputs.docker-image || needs.build-image.outputs.docker-image }}"
          TAG="${DOCKER_IMAGE##*:}"

          echo "Setting latest tag for Docker images with tag: $TAG"

          for IMAGE_SUFFIX in "-dev" "-user"; do
            IMAGE_NAME="ghcr.io/tenstorrent/tt-lang/tt-lang${IMAGE_SUFFIX}-ubuntu-22-04"
            echo "Tagging ${IMAGE_NAME}:${TAG} as latest"
            skopeo copy "docker://${IMAGE_NAME}:${TAG}" "docker://${IMAGE_NAME}:latest"
          done

          echo "Latest tags set successfully"
