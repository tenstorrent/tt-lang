name: Build Docker Image

on:
  push:
    # TODO: Remove branches trigger after testing - this is temporary for testing
    branches:
      - '*'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    # TODO: Remove pull_request trigger after testing - this is temporary for testing
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      ttlang_sha_override:
        description: "tt-lang SHA/branch override (optional, defaults to current commit)"
        type: string
        required: false
      mlir_override:
        description: "tt-mlir SHA override (optional, defaults to third-party/tt-mlir.commit)"
        type: string
        required: false
  workflow_call:
    inputs:
      mlir_override:
        description: "tt-mlir SHA override (optional, defaults to third-party/tt-mlir.commit)"
        type: string
        required: false
    outputs:
      docker-image:
        description: "Built Docker image name with tag"
        value: ${{ jobs.check-if-docker-exist.outputs.docker-image || jobs.build-image.outputs.docker-image }}
      docker-image-base:
        description: "Base Docker image name with tag"
        value: ${{ jobs.check-if-docker-exist.outputs.docker-image-base || jobs.build-image.outputs.docker-image-base }}

permissions:
  packages: write
  checks: write

jobs:
  check-if-docker-exist:
    runs-on: ubuntu-latest
    outputs:
      docker-image: ${{ steps.check.outputs.docker-image }}
      docker-image-base: ${{ steps.check.outputs.docker-image-base }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ttlang_sha_override || github.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Read tt-mlir commit
        id: ttmlir-commit
        run: |
          COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Check if Docker image exists
        id: check
        run: .github/scripts/check-docker-images.sh "${{ steps.mlir-commit.outputs.commit }}"
        continue-on-error: true

  build-image:
    needs: check-if-docker-exist
    if: needs.check-if-docker-exist.outputs.docker-image == ''
    runs-on: ubuntu-latest

    env:
      TT_MLIR_DIR: ${{ github.workspace }}/tt-mlir-install
      TTMLIR_TOOLCHAIN_DIR: /opt/ttmlir-toolchain

    container: ghcr.io/tenstorrent/tt-mlir/tt-mlir-ci-ubuntu-22-04:latest

    outputs:
      docker-image: ${{ steps.build.outputs.docker-image }}
      docker-image-base: ${{ steps.build.outputs.docker-image-base }}
    steps:
      - name: Maximize space
        uses: tenstorrent/tt-github-actions/.github/actions/maximize_space@main

      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ttlang_sha_override || github.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Read tt-mlir commit
        id: ttmlir-commit
        run: |
          COMMIT=$(cat third-party/tt-mlir.commit | tr -d '[:space:]')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Restore tt-mlir from cache
        id: cache-ttmlir
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.TT_MLIR_DIR }}
          key: ${{ runner.os }}-ttlang-ttmlir-${{ steps.ttmlir-commit.outputs.commit }}
          fail-on-cache-miss: false

      - name: Check if cache was restored
        if: steps.cache-ttmlir.outputs.cache-hit != 'true'
        run: |
          echo "::warning::tt-mlir cache key ${{ runner.os }}-ttlang-ttmlir-${{ steps.ttmlir-commit.outputs.commit }} not found for commit ${{ steps.ttmlir-commit.outputs.commit }}"
          echo "::warning::Skipping Docker build - run on-push workflow first to populate cache"
          exit 1

      - name: Build Docker images
        id: build
        run: |
          .github/containers/build-docker-images.sh "${{ steps.ttmlir-commit.outputs.commit }}" --tt-mlir-dir "${{ env.TT_MLIR_DIR }}"

      - name: Read Docker image name
        id: image-name
        run: |
          if [ ! -f .docker-image-name ]; then
            echo "Error: .docker-image-name file not found"
            exit 1
          fi
          DOCKER_IMAGE=$(cat .docker-image-name)
          echo "docker-image=$DOCKER_IMAGE" >> $GITHUB_OUTPUT

          # Create base variant
          DOCKER_IMAGE_BASE="${DOCKER_IMAGE/tt-lang-dist-ubuntu/tt-lang-base-ubuntu}"
          echo "docker-image-base=$DOCKER_IMAGE_BASE" >> $GITHUB_OUTPUT

          echo "✓ Docker images built successfully"

  set-latest-tag:
    needs: [check-if-docker-exist, build-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !failure()
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Set latest tag
        run: |
          # Get the image name (from either check or build job)
          DOCKER_IMAGE="${{ needs.check-if-docker-exist.outputs.docker-image || needs.build-image.outputs.docker-image }}"

          # Extract the tag from the full image name
          TAG="${DOCKER_IMAGE##*:}"

          echo "Setting latest tag for Docker images with tag: $TAG"

          # Tag all image variants as latest
          for IMAGE_SUFFIX in "-base" "-ci" "-ird" "-dist"; do
            IMAGE_NAME="ghcr.io/tenstorrent/tt-lang/tt-lang${IMAGE_SUFFIX}-ubuntu-22-04"
            echo "Tagging ${IMAGE_NAME}:${TAG} as latest"
            skopeo copy "docker://${IMAGE_NAME}:${TAG}" "docker://${IMAGE_NAME}:latest"
          done

          echo "✓ Latest tags set successfully"
