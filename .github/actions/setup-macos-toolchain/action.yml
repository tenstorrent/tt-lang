name: Setup macOS Toolchain
description: Install dependencies and build/cache tt-mlir toolchain for macOS

inputs:
  tt-mlir-path:
    description: Path to tt-mlir checkout
    required: true

runs:
  using: composite
  steps:
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      shell: bash
      run: |
        brew install cmake ninja
        python -m pip install --upgrade pip

    - name: Create toolchain directory
      shell: bash
      run: |
        sudo mkdir -p /opt/ttmlir-toolchain
        sudo chown -R $USER /opt/ttmlir-toolchain

    - name: Cache tt-mlir toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: /opt/ttmlir-toolchain
        key: macos-ttmlir-toolchain-${{ hashFiles(format('{0}/env/CMakeLists.txt', inputs.tt-mlir-path)) }}-${{ github.ref_name }}
        restore-keys: |
          macos-ttmlir-toolchain-${{ hashFiles(format('{0}/env/CMakeLists.txt', inputs.tt-mlir-path)) }}

    - name: Build tt-mlir toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      shell: bash
      run: |
        cd ${{ inputs.tt-mlir-path }}
        cmake -B env/build env
        cmake --build env/build
