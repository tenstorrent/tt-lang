# tt-lang
TT-Lang is a Python-based DSL that enables authoring of programs for TT hardware.

See [RFC document](https://docs.google.com/document/d/1T8Htv9nfdufebajJidzYHfDfsSnru_9xn_whdyxn6Po/edit?usp=sharing).

## Build System

tt-lang uses a CMake-based build system that reuses tt-mlir's environment and toolchain. See [BUILD_SYSTEM.md](BUILD_SYSTEM.md) for complete documentation.

## Quick Start

### Prerequisites

tt-lang depends on tt-mlir. The build system supports three integration scenarios:

1. **Pre-built tt-mlir** - Use a tt-mlir build tree (for development)
2. **Pre-installed tt-mlir** - Use an installed tt-mlir toolchain
3. **Automatic build** - Let the build system fetch and build tt-mlir automatically

### Scenario 1: Using Pre-built tt-mlir (Development Mode)

If you're developing tt-mlir alongside tt-lang, you can point to your tt-mlir build directory:

```bash
# First, build tt-mlir
cd /path/to/tt-mlir
source env/activate
cmake -GNinja -Bbuild .
cmake --build build

# Then configure and build tt-lang pointing to the tt-mlir build tree
cd /path/to/tt-lang
cmake -GNinja -Bbuild . -DTTMLIR_BUILD_DIR=/path/to/tt-mlir/build
source build/env/activate  # Generated by CMake with correct paths
cmake --build build
```

The CMake configure step generates an `env/activate` script that uses the Python environment and toolchain from the tt-mlir build.

### Scenario 2: Using Pre-installed tt-mlir (Recommended)

If you have tt-mlir installed at `/opt/ttmlir-toolchain` (default) or another location:

```bash
cd /path/to/tt-lang
cmake -GNinja -Bbuild .
source build/env/activate
cmake --build build
```

To use a custom installation location:

```bash
cmake -GNinja -Bbuild . -DTTMLIR_TOOLCHAIN_DIR=/path/to/ttmlir-toolchain
source build/env/activate
cmake --build build
```

The CMake configure step generates an `env/activate` script that finds the installed tt-mlir and uses its toolchain and Python environment.

**Important:** The pre-installed tt-mlir must be built with Python bindings enabled (`-DTTMLIR_ENABLE_BINDINGS_PYTHON=ON`). See the [tt-mlir Getting Started guide](https://docs.tenstorrent.com/tt-mlir/getting-started.html) for details on building tt-mlir with Python bindings.

### Scenario 3: Automatic Build (Fallback)

If tt-mlir is not found, the build system will automatically:
1. Fetch the version specified in `third-party/tt-mlir.commit`
2. Build it with appropriate platform-specific options
3. Install it locally in the build directory

```bash
cd /path/to/tt-lang
cmake -GNinja -Bbuild .
source build/env/activate
cmake --build build
```

The tt-mlir will be built and installed to `build/tt-mlir-install/`. The generated `env/activate` script will automatically use this local installation. This process requires:
- An existing LLVM/MLIR toolchain at `TTMLIR_TOOLCHAIN_DIR` (default: `/opt/ttmlir-toolchain`)
- Python 3.11+ in the toolchain's virtual environment

**Build options:**
```bash
# Debug build with Python bindings
cmake -GNinja -Bbuild . -DCMAKE_BUILD_TYPE=Debug -DTTLANG_ENABLE_BINDINGS_PYTHON=ON

# Enable code coverage
cmake -GNinja -Bbuild . -DCODE_COVERAGE=ON
```

**Note:** The `third-party/tt-mlir.commit` file contains the reference tt-mlir version. The build system ensures version compatibility automatically.


## Developer Guidelines

### Updating tt-mlir version

Update the `third-party/tt-mlir.commit` file to the desired commit SHA.

- **Scenario 1 (Pre-built)**: Check out the new SHA in your tt-mlir repository and rebuild.
- **Scenario 2 (Pre-installed)**: Install the new tt-mlir version to your toolchain directory.
- **Scenario 3 (Automatic)**: The build system will automatically fetch and build the new version on the next clean build.

### Code Formatting with Pre-commit

tt-lang uses [pre-commit](https://pre-commit.com/) to automatically format code and enforce style guidelines before commits.

#### Installation

Install pre-commit using pip:

```bash
pip install pre-commit
```

Or using your system package manager:
```bash
# macOS
brew install pre-commit

# Ubuntu/Debian
sudo apt install pre-commit
```

#### Setup

After cloning the repository, install the git hook scripts:

```bash
cd /path/to/tt-lang
pre-commit install
```

This will configure git to run `pre-commit` checks before each commit.

#### Usage

Once installed, `pre-commit` will automatically run when you commit:

```bash
git commit -m "Your commit message"
```

Pre-commit will:
- Format Python code with [Black](https://github.com/psf/black)
- Format C++ code with [clang-format](https://clang.llvm.org/docs/ClangFormat.html) (LLVM style)
- Remove trailing whitespace
- Ensure files end with a single newline
- Check YAML and TOML syntax
- Check for large files
- Check for valid copyright notice

If `pre-commit` makes changes, the commit will be stopped. Review the changes, stage them, and commit again:

```bash
git add -u
git commit -m "Your commit message"
```

#### Manual Formatting

To run pre-commit checks manually on all files:

```bash
pre-commit run --all-files
```

To run on specific files:

```bash
pre-commit run --files path/to/file1.py path/to/file2.cpp
```

#### Skipping Pre-commit (Not Recommended)

In rare cases where you need to skip pre-commit checks:

```bash
git commit --no-verify -m "Your commit message"
```

**Note:** CI will still run these checks, so skipping locally may cause CI failures.
