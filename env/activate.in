# SPDX-FileCopyrightText: (c) 2025 Tenstorrent AI ULC
#
# SPDX-License-Identifier: Apache-2.0

# tt-lang environment activation (generated by CMake)
# This script activates the tt-mlir toolchain environment and adds tt-lang specific paths.

# Check for quiet flag
_TTLANG_QUIET=0
if [ "$1" = "-q" ] || [ "$1" = "--quiet" ]; then
  _TTLANG_QUIET=1
fi

# Guard against re-activation.
if [ -n "${TTLANG_ENV_ACTIVATED}" ]; then
  deactivate 2>/dev/null || :
  unset TTLANG_ENV_ACTIVATED
fi

# Set tt-lang home directory.
export TT_LANG_HOME="@TT_LANG_HOME@"

# Set toolchain directory (configured by CMake).
export TTMLIR_TOOLCHAIN_DIR="@TTMLIR_TOOLCHAIN_DIR@"

# Activate the Python virtual environment from the toolchain.
if [ -f "${TTMLIR_TOOLCHAIN_DIR}/venv/bin/activate" ]; then
  . "${TTMLIR_TOOLCHAIN_DIR}/venv/bin/activate"
else
  echo "WARNING: Python virtual environment not found at ${TTMLIR_TOOLCHAIN_DIR}/venv"
  echo "Python packages may not be available."
fi

# Add tt-lang build directories and toolchain to PATH and PYTHONPATH.
export PATH="${TTMLIR_TOOLCHAIN_DIR}/bin:@CMAKE_BINARY_DIR@/bin:@TTMLIR_PATH@/bin:$PATH"

export PYTHONPATH="\
@CMAKE_BINARY_DIR@/python_packages:\
${TT_LANG_HOME}/python:\
@TTMLIR_PATH@/python_packages:\
@TTMLIR_PATH@/ttrt/runtime/ttnn:\
@TTMLIR_PATH@/python_packages/ttrt/runtime/tt_metal:\
$PYTHONPATH"

# TODO(#200): Fix this hack to not require tt-mlir source directory to be present
if [ -z "${TT_METAL_RUNTIME_ROOT}" ] && [ -d "@TTMLIR_PATH@/../third_party/tt-metal/src/tt-metal" ]; then
  export TT_METAL_RUNTIME_ROOT="@TTMLIR_PATH@/../third_party/tt-metal/src/tt-metal"
  export TT_METAL_HOME="$TT_METAL_RUNTIME_ROOT"
elif [ -z "${TT_METAL_RUNTIME_ROOT}" ]; then
  echo "WARNING: You need to set TT_METAL_RUNTIME_ROOT to run on TT hardware"
fi

# Mark environment as activated.
export TTLANG_ENV_ACTIVATED=1

if [ "${_TTLANG_QUIET}" -eq 0 ]; then
  echo "tt-lang environment activated"
  echo "  tt-mlir: @TTMLIR_PATH@"
  echo "  Toolchain: ${TTMLIR_TOOLCHAIN_DIR}"
  echo "  Python: $(which python3)"
fi
