# SPDX-FileCopyrightText: (c) 2025 Tenstorrent AI ULC
#
# SPDX-License-Identifier: Apache-2.0

# tt-lang environment activation (generated by CMake)
# This script activates the tt-mlir toolchain environment and adds tt-lang specific paths.

# Check for verbose flag
_TTLANG_VERBOSE=0
if [ "$1" = "-v" ] || [ "$1" = "--verbose" ]; then
  _TTLANG_VERBOSE=1
fi

# Guard against re-activation.
if [ -n "${TTLANG_ENV_ACTIVATED}" ]; then
  deactivate 2>/dev/null || :
  unset TTLANG_ENV_ACTIVATED
fi

# Set tt-lang home directory.
export TT_LANG_HOME="@TT_LANG_HOME@"

# Set toolchain directory (configured by CMake).
export TTMLIR_TOOLCHAIN_DIR="@TTMLIR_TOOLCHAIN_DIR@"

# Activate the Python virtual environment from the toolchain.
if [ -f "${TTMLIR_TOOLCHAIN_DIR}/venv/bin/activate" ]; then
  . "${TTMLIR_TOOLCHAIN_DIR}/venv/bin/activate"
else
  echo "WARNING: Python virtual environment not found at ${TTMLIR_TOOLCHAIN_DIR}/venv"
  echo "Python packages may not be available."
fi

# Add tt-lang build directories and toolchain to PATH and PYTHONPATH.
export PATH="${TTMLIR_TOOLCHAIN_DIR}/bin:@CMAKE_BINARY_DIR@/bin:@TTMLIR_PATH@/bin:$PATH"

export PYTHONPATH="\
@CMAKE_BINARY_DIR@/python_packages:\
${TT_LANG_HOME}/python:\
@TTMLIR_PATH@/python_packages:\
@TTMLIR_PATH@/ttrt/runtime/ttnn:\
$PYTHONPATH"

# Set LD_LIBRARY_PATH to find tt-mlir shared libraries (e.g., _ttnncpp.so)
export LD_LIBRARY_PATH="@TTMLIR_PATH@/lib:${TTMLIR_TOOLCHAIN_DIR}/lib:${LD_LIBRARY_PATH}"

# Set TT_METAL_RUNTIME_ROOT if not already set
# The path is determined by CMake at configure time in ExternTTMLIR.cmake
if [ -z "${TT_METAL_RUNTIME_ROOT}" ]; then
  if [ -n "@TT_METAL_RUNTIME_ROOT@" ]; then
    export TT_METAL_RUNTIME_ROOT="@TT_METAL_RUNTIME_ROOT@"
    export TT_METAL_HOME="$TT_METAL_RUNTIME_ROOT"
  else
    echo "WARNING: TT_METAL_RUNTIME_ROOT not configured. You may need to set it manually to run on TT hardware"
  fi
fi

# Mark environment as activated.
export TTLANG_ENV_ACTIVATED=1

if [ "${_TTLANG_VERBOSE}" -ne 0 ]; then
  echo "tt-lang environment activated"
  echo "  Python:                $(which python3)"
  echo "  TT-MLIR:               @TTMLIR_PATH@"
  echo "  Toolchain:             ${TTMLIR_TOOLCHAIN_DIR}"
  echo "  TT_METAL_RUNTIME_ROOT: ${TT_METAL_RUNTIME_ROOT}"
  echo "  LD_LIBRARY_PATH:       ${LD_LIBRARY_PATH}"
fi
